# CLAUDE.md

This file provides guidance to Claude Code (claude.ai/code) when working with code in this repository.

## Common Development Commands

### Build and Development
- `flutter pub get` - Install dependencies
- `flutter run` - Run the application 
- `dart run build_runner build -d` - Generate required files (localization, code generation)
- `flutter test` - Run unit tests
- `flutter test integration_test/` - Run integration tests
- `flutter analyze` - Static code analysis and linting
- `flutter format .` - Format code

### Code Generation
- Run `dart run build_runner build -d` after installing dependencies or updating localization files
- This generates files needed by `flutter_intl` and other code generators

## Architecture Overview

### State Management: Riverpod
- Uses **Riverpod** for dependency injection and state management
- Providers are organized by feature in `features/{feature}/providers/`
- **Notifier pattern** for complex state logic (authentication, order management)
- Notifiers encapsulate business logic and expose state via providers

### Data Layer
- **Sembast** NoSQL database for local persistence
- Database initialization in `shared/providers/mostro_database_provider.dart`
- Repository pattern: All data access through repository classes in `data/repositories/`
- Models exported through `data/models.dart`

### Nostr Integration
- **NostrService** (`services/nostr_service.dart`) manages relay connections and messaging
- All Nostr protocol interactions go through this service
- **MostroFSM** (`core/mostro_fsm.dart`) manages order state transitions

### Navigation and UI
- **GoRouter** for navigation (configured in `core/app_routes.dart`)
- **flutter_intl** for internationalization (`l10n/` directory)
- Background services in `background/` for notifications and data sync

### Key Architecture Patterns
- Feature-based organization: `features/{feature}/{screens|providers|notifiers|widgets}/`
- Shared utilities and widgets in `shared/`
- Repository pattern for data access
- Provider pattern for dependency injection
- FSM pattern for order lifecycle management

## Timeout Detection & Reversal System

### Overview
Real-time system that detects when orders timeout from `waiting-buyer-invoice` or `waiting-payment` states and handles maker/taker scenarios differently to maintain UI consistency with mostrod state.

### Detection Mechanism
- **Monitors**: 38383 public events for status changes
- **Triggers**: When public event shows different status than local state (simplified logic without timestamp comparison)
- **Real-time**: Subscribes to `orderEventsProvider` for instant detection

### Maker Scenario (Order Creator)
When taker doesn't respond and order returns to pending:
- **Session**: Preserved (keeps order in "My Trades")
- **State**: Updated to `Status.pending` with `Action.timeoutReversal`
- **Persistence**: Creates synthetic `MostroMessage.createTimeoutReversal()` stored with unique key
- **Result**: Order remains visible but shows pending status after app restart

### Taker Scenario (Order Taker)
When user doesn't respond and order returns to pending:
- **Session**: Deleted completely via `sessionNotifier.deleteSession()`
- **State**: Provider invalidated (`ref.invalidateSelf()`)
- **Result**: Order disappears from "My Trades" and reappears in order book for retaking

### Cancellation Detection & Cleanup
When orders are canceled (status changes to `canceled` in public events):
- **Detection**: Public event monitoring system (independent of timestamps)
- **Session Cleanup**: State-based logic - only deletes session for pending/waiting states
- **Active Orders**: Canceled active orders keep session but update to canceled status
- **UI Behavior**: Pending/waiting orders disappear, active orders show canceled status
- **User Feedback**: Shows cancellation notification
- **Implementation**: `_checkTimeoutAndCleanup()` method in `order_notifier.dart:172-211`

### Key Implementation
- **Race protection**: `_isProcessingTimeout` flag prevents concurrent execution (with proper early return handling)
- **Role detection**: `_isCreatedByUser()` compares session role with order type
- **Error resilience**: Timeouts and try-catch blocks prevent app hangs
- **Notifications**: Differentiated messages for maker vs taker scenarios
- **Simplified Logic**: Status-based detection without timestamp comparison
- **State-based Rules**: Different session handling based on local order state (pending/waiting vs active)
- **Timeout Detection**: `public=pending + local=waiting = guaranteed timeout`

### Testing Structure
- Unit tests in `test/` directory
- Integration tests in `integration_test/`
- Mocks generated using Mockito in `test/mocks.dart`

### Mock Files Guidelines  
- **Generated file**: `test/mocks.mocks.dart` is auto-generated by Mockito
- **File-level ignores**: Already contains `// ignore_for_file: must_be_immutable` at top
- **DO NOT add**: Individual `// ignore: must_be_immutable` comments to classes
- **Common issue**: Adding individual ignores causes `duplicate_ignore` analyzer warnings
- **MockSharedPreferencesAsync**: Specifically covered by existing file-level ignore
- **Regeneration**: Use `dart run build_runner build -d` to update mocks

## Development Guidelines

### State Management
- Use Riverpod for all state management
- Encapsulate business logic in Notifiers
- Access data only through repository classes
- Use post-frame callbacks for side effects like SnackBars/dialogs

### Code Organization
- Follow existing feature-based folder structure
- Keep UI code declarative and side-effect free
- Use `S.of(context).yourKey` for all user-facing strings
- Refer to existing features (order, chat, auth) for implementation patterns

### Key Services and Components
- **MostroService** - Core business logic and Mostro protocol handling
- **NostrService** - Nostr protocol connectivity
- **Background services** - Handle notifications and background tasks
- **Key management** - Cryptographic key handling and storage
- **Exchange service** - Fiat/Bitcoin exchange rate handling

## Internationalization (i18n)

### Current Localization Setup
- **Primary languages**: English (en), Spanish (es), Italian (it)
- **ARB files location**: `lib/l10n/`
  - `intl_en.arb` - English (base language)
  - `intl_es.arb` - Spanish translations
  - `intl_it.arb` - Italian translations
- **Generated files**: `lib/generated/l10n.dart` and language-specific files
- **Usage**: Import `import 'package:mostro_mobile/generated/l10n.dart';` and use `S.of(context)!.keyName`

### Localization Best Practices
- **Always use localized strings**: Replace hardcoded text with `S.of(context)!.keyName`
- **ARB file structure**: Add new keys to all three ARB files (en, es, it)
- **Parameterized strings**: Use proper ARB metadata for strings with parameters
- **Regenerate after changes**: Run `dart run build_runner build -d` after ARB modifications
- **Context usage**: Pass BuildContext to methods that need localization

### TimeAgo Localization
- **Package**: Uses `timeago` package for relative time formatting
- **Setup**: Locales configured in `main.dart` with `timeago.setLocaleMessages()`
- **Implementation**: Custom `timeAgoWithLocale()` method in NostrEvent extension
- **Usage**: Automatically uses app's current locale for "hace X horas" vs "hours ago"

## Code Quality Standards

### Flutter Analyze
- **Target**: Zero `flutter analyze` issues
- **Deprecation handling**: Always use latest APIs (e.g., `withValues()` instead of `withOpacity()`)
- **BuildContext async gaps**: Always check `mounted` before using context after async operations
- **Imports**: Remove unused imports and dependencies
- **Immutability**: Use `const` constructors where possible

### Generated Files & Analyzer Issues
- **DO NOT** add ignore comments to generated files (`*.g.dart`, `*.mocks.dart`)
- **MockSharedPreferencesAsync warning**: File already has `// ignore_for_file: must_be_immutable`
- **duplicate_ignore warnings**: Usually caused by adding individual ignores to files with file-level ignores
- **Solution**: Regenerate files with `dart run build_runner build -d` instead of adding ignores
- **Mock files**: Never manually edit `test/mocks.mocks.dart` - it's auto-generated by Mockito

### Git Workflow
- **Branch naming**: Feature branches like `feat/feature-name`
- **Commit messages**: Descriptive messages following conventional commits
- **No Claude references**: Don't include Claude/AI references in commit messages
- **Code review**: All changes should pass `flutter analyze` before commit

## Project Context & Recent Work

### Major Features Completed

#### 1. Comprehensive Multi-Language Support
- **Complete Localization**: Added 73+ new localization keys across all screens
- **Three Languages**: Full support for English (en), Spanish (es), and Italian (it)
- **Advanced Time Formatting**: Fixed timeago package to show "hace X horas" instead of "hours ago"
- **Localized UI Components**: All user-facing strings properly internationalized
- **ARB File Management**: Organized translation files with proper metadata

#### 2. Modern UI/UX Enhancements  
- **App Icon Improvements**: Enhanced app launcher icon with proper adaptive icon support
- **Notification Icons**: Improved notification icons for better visibility
- **Card-Based Settings**: Clean, organized settings interface with visual hierarchy
- **Enhanced Account Screen**: Streamlined user profile and preferences
- **Currency Integration**: Visual currency flags for international trading
- **Relay Management**: Localized relay dialog strings and improved UX

#### 3. Code Quality Excellence
- **Zero Analyzer Issues**: Resolved 54+ Flutter analyze issues, maintaining clean codebase
- **Modern APIs**: Updated all deprecated APIs to latest Flutter standards
- **BuildContext Safety**: Fixed async gaps with proper mounted checks
- **Code Cleanup**: Removed unused imports and dependencies
- **Const Optimization**: Added const constructors where possible

#### 4. Technical Architecture Improvements
- **Proper Timeago Localization**: Implemented locale-aware time formatting system
- **Enhanced NostrEvent Extension**: Added locale-aware methods for better UX
- **Improved Error Handling**: Better user feedback and error recovery
- **Background Services**: Reliable notification processing
- **Mock File Management**: Comprehensive documentation to prevent generated file issues

### Recent File Modifications

#### Core Infrastructure
- **`lib/main.dart`**: Timeago locale setup and app initialization
- **`lib/core/app_routes.dart`**: Navigation configuration and routing
- **`lib/core/app_theme.dart`**: UI theme and styling consistency

#### Localization System
- **`lib/l10n/*.arb`**: Complete translation files for en/es/it
- **`lib/generated/l10n*.dart`**: Generated localization classes
- **Multiple widget files**: Converted hardcoded strings to localized versions

#### UI Components
- **`lib/shared/widgets/bottom_nav_bar.dart`**: Enhanced navigation with notification badges
- **`lib/features/home/screens/home_screen.dart`**: Modern order book interface
- **`lib/features/relays/widgets/relay_selector.dart`**: Localized relay management
- **Settings screens**: Card-based layout with improved accessibility

#### Notification System
- **`lib/notifications/notification_service.dart`**: Custom notification icons and improved delivery
- **Android resources**: Added notification icon assets in all density folders
- **iOS configuration**: Enhanced notification handling for iOS platform

#### Icon Assets
- **`android/app/src/main/res/`**: Adaptive icon configuration and assets
- **`pubspec.yaml`**: Updated flutter_launcher_icons configuration
- **Platform-specific assets**: Proper density support for all screen sizes

### Quality Assurance & Testing
- **Zero Flutter Analyze Issues**: Maintained throughout development
- **Comprehensive Testing**: All tests passing with proper mock implementations
- **Multi-Language Testing**: Verified localization across all supported languages
- **Platform Testing**: Validated on both Android and iOS devices
- **Performance Testing**: Ensured smooth animations and responsive UI

### Documentation Improvements
- **Enhanced CLAUDE.md**: Updated development guidelines and project context
- **New NOSTR.md**: Comprehensive technical documentation for Nostr integration
- **Updated README.md**: Modern feature overview and development guide
- **Code Documentation**: Improved inline documentation and comments

## User Preferences & Working Style

### Development Approach
- **Systematic implementation**: Break complex tasks into manageable steps
- **Quality focus**: Always run `flutter analyze` and fix issues
- **Documentation**: Update this file when making architectural changes
- **Testing**: Verify changes don't break existing functionality

### Communication Style
- **Concise responses**: Keep explanations brief and to the point
- **Code-first**: Show implementation rather than lengthy explanations
- **Problem-solving**: Focus on root cause analysis and systematic fixes
- **Best practices**: Always follow Flutter and Dart conventions

### Git Practices
- **Clean commits**: Focused, single-purpose commits
- **Descriptive messages**: Clear commit messages without AI references
- **Branch management**: Use feature branches for development
- **Push workflow**: Always test before pushing to remote

## Important File Locations

### Configuration Files
- `pubspec.yaml` - Dependencies and Flutter configuration
- `analysis_options.yaml` - Linting rules and code analysis
- `lib/core/app_routes.dart` - Navigation configuration
- `lib/core/app_theme.dart` - UI theme and styling

### Key Directories
- `lib/features/` - Feature-based organization
- `lib/shared/` - Shared utilities and components
- `lib/data/` - Models, repositories, and data management
- `lib/services/` - Core services (Nostr, Mostro, etc.)
- `lib/l10n/` - Internationalization files
- `test/` - Unit and integration tests

### Generated Files (Don't Edit Manually)
- `lib/generated/` - Generated localization files
- `*.g.dart` - Generated Riverpod and other code
- `*.mocks.dart` - Generated Mockito mock files (especially `test/mocks.mocks.dart`)
- Platform-specific generated files

### Generated Files Best Practices
- **NEVER manually edit** generated files (`.g.dart`, `.mocks.dart`, `lib/generated/`)
- **NEVER add individual ignore comments** to generated files (e.g., `// ignore: must_be_immutable`)
- **DO NOT modify** `test/mocks.mocks.dart` - it already has file-level ignores
- **If analyzer issues exist**: Regenerate files instead of adding ignores
- **Mock files specifically**: Have file-level `// ignore_for_file: must_be_immutable` - don't add more
- **Regeneration commands**: 
  - Riverpod: `dart run build_runner build -d`
  - Mocks: `dart run build_runner build -d`
  - Localization: `flutter gen-l10n`

## Notes for Future Development

- Always maintain zero Flutter analyze issues
- Test localization changes in all supported languages
- Update this documentation when making architectural changes
- Follow existing patterns when adding new features
- Prioritize user experience and code maintainability

## Important Reminders for Claude Code

### Generated Files - CRITICAL
- **NEVER** manually edit `test/mocks.mocks.dart` or any `*.g.dart` files
- **NEVER** add `// ignore: must_be_immutable` to individual classes in generated files
- **MockSharedPreferencesAsync** already has file-level ignore - don't add more
- **duplicate_ignore warnings** are caused by adding individual ignores to files with file-level ignores
- **Solution**: Always regenerate files instead of adding ignore comments

---

**Last Updated**: 2025-07-20  
**Flutter Version**: Latest stable  
**Dart Version**: Latest stable  
**Key Dependencies**: Riverpod, GoRouter, flutter_intl, timeago, dart_nostr

## Current Project Status

### Technical Excellence
- ✅ **Zero Flutter Analyze Issues**: Maintained clean codebase
- ✅ **Modern APIs**: All deprecated warnings resolved
- ✅ **Comprehensive Localization**: English, Spanish, Italian support
- ✅ **Enhanced UI/UX**: Modern card-based interfaces
- ✅ **Improved Icons**: App launcher and notification icons
- ✅ **Documentation**: Complete technical and user guides

### Active Features
- 🎯 **Core Trading**: Full buy/sell order management
- 💬 **Secure Chat**: NIP-59 encrypted peer-to-peer messaging  
- 🔐 **Privacy**: Hierarchical key management with trade-specific keys
- ⚡ **Lightning**: Seamless Lightning Network integration
- 🌐 **Multi-Platform**: Android and iOS native performance
- 📱 **Real-Time**: Live updates via Nostr protocol

### Recent Achievements
- **UI Modernization**: Complete settings and account screen redesign
- **Icon Enhancement**: Improved app launcher and notification visibility
- **Localization Excellence**: 73+ new translation keys across 3 languages
- **Code Quality**: Zero analyzer issues with modern Flutter standards
- **Documentation**: Comprehensive NOSTR.md and updated README.md